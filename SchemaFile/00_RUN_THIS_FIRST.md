# üö® IMPORTANT: Run Scripts in This Order!

## Problem
Your existing Supabase tables use **UUID** for `id` columns, but this project uses **bigint**.

When you try to create foreign keys, you get:
```
ERROR: foreign key constraint cannot be implemented
DETAIL: Key columns "rua_id" and "id" are of incompatible types: bigint and uuid.
```

## Solution: Run Scripts in Order

### Step 1: Convert Existing Tables (If you have data)
**File:** `SchemaFixes.md`

This script:
- Drops all foreign key constraints
- Converts all `id` columns from UUID to bigint
- Recreates foreign keys with correct types

**‚ö†Ô∏è WARNING:** This will **drop and recreate** `id` columns. Your data will be preserved but IDs will change!

```sql
-- Run this FIRST if you have existing tables with UUIDs
-- Copy/paste from SchemaFixes.md into Supabase SQL Editor
```

---

### Step 2: Create New Tables
After Step 1 (or if starting fresh), run these in order:

1. **Cities** (if not exists)
   ```sql
   create table if not exists public.cities (
     id bigint primary key generated by default as identity,
     nome text not null,
     created_at timestamptz default now()
   );
   ```

2. **Organizations** (if not exists)
   ```sql
   create table if not exists public.organizations (
     id bigint primary key generated by default as identity,
     nome text not null,
     created_at timestamptz default now()
   );
   ```

3. **Streets** (if not exists)
   ```sql
   create table if not exists public.streets (
     id bigint primary key generated by default as identity,
     created_at timestamptz default now(),
     nome text not null,
     cidade_id bigint references public.cities(id) on delete set null
   );
   ```

4. **Businesses** - `businessschema.md`

5. **Stories** - `storioesschema.md`

6. **Ads** - `ads_schema.md`

---

## Quick Fix for Your Current Error

If you're getting the error right now, run this:

```sql
-- 1. Drop the problematic constraint
alter table stories drop constraint if exists stories_rua_id_fkey;

-- 2. Check what type streets.id is
select column_name, data_type 
from information_schema.columns 
where table_name = 'streets' and column_name = 'id';

-- If it shows 'uuid', you need to convert it:

-- 3a. If streets.id is UUID, convert it to bigint
alter table streets drop constraint if exists streets_pkey;
alter table streets drop column if exists id;
alter table streets add column id bigint generated by default as identity primary key;

-- 3b. Also convert stories.rua_id to bigint
alter table stories drop column if exists rua_id;
alter table stories add column rua_id bigint;

-- 4. Now add the foreign key
alter table stories add constraint stories_rua_id_fkey
  foreign key (rua_id) references streets(id) on delete set null;
```

---

## For Fork Owners: Fresh Start

If you're setting up a **new** Supabase project (no existing data):

### Option 1: Use bigint (Recommended)
```sql
-- 1. Create cities
create table public.cities (
  id bigint primary key generated by default as identity,
  nome text not null
);

-- 2. Create streets
create table public.streets (
  id bigint primary key generated by default as identity,
  nome text not null,
  cidade_id bigint references public.cities(id)
);

-- 3. Create organizations
create table public.organizations (
  id bigint primary key generated by default as identity,
  nome text not null
);

-- 4. Create businesses (see businessschema.md)

-- 5. Create stories (see storioesschema.md)

-- 6. Create ads (see ads_schema.md)
```

### Option 2: Use UUID (Alternative)
If you prefer UUID, change **all** schemas:
- Replace `bigint` with `uuid`
- Replace `generated by default as identity` with `default gen_random_uuid()`

---

## Summary

**The issue:** Mixing UUID and bigint types in foreign keys

**The fix:** 
- Either convert everything to bigint (recommended)
- Or convert everything to UUID
- **Never mix both!**

**Current project uses:** bigint for all IDs

**Run order:**
1. `SchemaFixes.md` (if converting existing tables)
2. Create parent tables (cities, organizations)
3. Create child tables (streets, businesses, stories, ads)
